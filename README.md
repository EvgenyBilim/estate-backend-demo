# Final Search: Агрегатор новостроек

В этом репозитории представлена часть бэкенда от действующего агрегатора новостроек.
Разрабатываемая версия находится по адресу [new.finalsearch.ru](https://new.finalsearch.ru).

## Архитектура проекта

Весь проект состоит из трех частей, каждая из которых расположена на разных серверах:
- Парсер планировок (Django) - собирает планировки от застройщиков и формирует из них xls-файл
- Бэкенд (Django) - хранит, вычисляет, фильтрует и отдает через API все данные по домам 
- Фронтенд (Vue)


## Архитектура бэкенда

Если в двух словах, то бэкенд хранит данные из xls-файлов и отдает эти данные в преобразованном виде через API на фронтенд.

Этот функционал разделен на три слоя, каждый из которых представляет собой отдельное django-приложение:
- ```core``` - функционал загрузки данных
- ```cache``` - кеширование
- ```estate_api``` - API с фильтрами данных

Давайте подробнее рассмотрим каждое из них.


### Core

Это приложение отвечает за то, как данные попадают и хранятся в базе данных.

Сначала происходит парсинг xls-файлов (список домов, корпуса, планировки, категории домов, линии метро) и запись данных в бд. После загрузки xls-файлов происходит вычисление всех данных, которые можно вычислить. Например - количество квартир в доме, минимальные и максимальные цены, типы отделок у дома и многие другие. 

Вычисленные данные так же пишутся в бд. Это нужно для увеличения производительности, чтобы данные не вычислялись каждый раз на лету при загрузке страницы.

Загрузка xls-фалов происходит в админке по адресу /uploads/.

В приложении есть два вида парсера - класс ```Uploader``` для xls-файлов и ```PhotoParser``` для архива с фото домов.
Uploader итерируется по xls-файлу и вызывает метод создания экземпляра у модели, которая подается на вход.
Для экономии обращений к бд ```Uploader``` использует ```bulk_create``` и пишет сразу по 5 000 строк за раз.

Управляющая логика вынесена в прослойки ```UploadManager``` и ```PhotoManager```, которые в свою очередь вызываются из ```Views.py.```

Это единственное приложение, которое находится в этом репозитории.

### Cache

У автора этого проекта (это я) был спортивный интерес сделать как можно более производительный фильтр по домам и планировкам. Поскольку все данные для поиска занимали около 3 мегабайт, было принято решение отказаться от прямого обращения к базе данных на диске и хранить данные для фильтров в оперативной памяти. Для этого был выбран Redis.

Это приложение как раз и занимается кэшированием данных. Оно формирует словари с нужной структурой и пишет их в Redis. Затем они используются для фильтров и отдачи статичных дынных для API из следующего приложения.

### Estate_api

Это приложение готовит данные из кэша и отдает их черех ```JsonResponse```. В этот слой вынесен фильтр по домам и планировкам.
